#set( $return = $imports.addToImports("java.util.*") )
#set( $postfix = "$utility.upFirstChar($sourceName)To$utility.upFirstChar($targetName)" )
#set( $iter = "fujaba__Iter$postfix" )
#set( $children = $utility.indent("      ",$!children) )
#set( $localVars = $engine.getFromInformation("localVars") )
#set( $return = $localVars.addLocalVariable($iter, "Iterator<?>", $link) )
#set( $searchOpComment = "iterate to-many link $link.InstanceOf.Name from $sourceName to $targetName" )
// $searchOpComment
#if ( $targetSet )
#set( $return = $imports.addToImports("de.upb.tools.fca.*") )
#set( $return = $localVars.addLocalVariable($collectionName, "FHashSet", $link) )
$collectionName = new FHashSet ();
#else
fujaba__Success = false;
#end
#if( $path )
#if( $path.contains("Util.") || $path.contains("Evaluator."))  
_TmpObject = ${path};
#elseif ( $source.InstanceOf == "EObject" )
#set( $return = $imports.addToImports("org.eclipse.emf.ecore.InternalEObject") )
_TmpObject = ((InternalEObject) ${sourceName}).${path};
#else
_TmpObject = ${sourceName}.${path};
#end
if (_TmpObject instanceof Iterator<?>) {
    $iter = (Iterator<?>)_TmpObject;    
}
else if (_TmpObject instanceof Iterable<?>) {
    $iter = ((Iterable<?>)_TmpObject).iterator();
}
else {
    $iter = Collections.singletonList(_TmpObject).iterator();
}
##$iter = new de.uni_kassel.sdm.Path ($sourceName, "$path");
##$iter = new Path ($sourceName, "$path");
#else
$iter = #parse("$!{style}storyPattern/link/iterator.vm" )

#end
#if ( $upperbound )
fujaba__UpperBound_$postfix = false;
#set( $return = $localVars.addLocalVariable("fujaba__UpperBound_$postfix","boolean","false", $link) )
#set( $upperadd = " && !(fujaba__UpperBound_$postfix)" )
#end
#if( $debug )
List<Exception> causes$postfix = new ArrayList<Exception>();
#end
while ( #if(!$forEach && !$targetSet || $targetNegative || $check)!(fujaba__Success) && #end${iter}.hasNext ()$!upperadd )
{
   try
   {
#if($check)
      if (!( ${targetName}.equals (${iter}.next ())#parse("$lang/default:storyPattern/sdmComment.vm") )) {throw new Exception("SDMException");};
#else
#set( $typeCast = (!$role.getTarget().equals($target.getInstanceOf())) )
#set( $source = "#if(!$typeCast)($targetType)#end ${iter}.next ()" )
#set( $toMany = true )
#set( $targetToken = $dlrTool.createDLRToken([$target]) )
$!targetToken.createStartTag()##
#set( $template = "$lang/default:storyPattern/object/assign.vm" )
$utility.indent("      ", "#parse($template)" )##
$!targetToken.createEndTag()##
#if($targetToken)#set( $targetToken.comment = $opComment )#end
#if ( $upperbound )
      if ( ${targetName}.equals ($upperbound) )
      {
         fujaba__UpperBound_$postfix = true;
         throw new Exception () ;
      }
#end
#end
#set( $opComment = $searchOpComment )
$!children
#if ( $targetSet )
      ${collectionName}.add ($targetName);
#else
      fujaba__Success = true;
#end
   }
   catch ( Exception fujaba__InternalException )
   {
#if( $debug )
      causes${postfix}.add (fujaba__InternalException);
#end
      fujaba__Success = false;
   }
}
#if ( $targetOptional )
if (!fujaba__Success)
{
   fujaba__Success = true;
   $targetName = null;
}
#elseif ( !$targetSet )
if (!(##
#if( $path && $linkNegative )!#end
fujaba__Success#if( $debug ), "$opComment", causes$postfix#end)) {throw new Exception("SDMException");};
#end
